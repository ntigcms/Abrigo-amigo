{% extends "principal.html" %}

{% block content %}
<h1 style="text-align:center; margin-bottom:25px;">Visualizar Atendimento</h1>

<form class="atendimento-form">

  <div class="form-grid">

      <!-- ID -->
      <div class="form-group">
          <label>ID:</label>
          <input type="text" value="{{ atendimento.id }}" readonly>
      </div>

      <!-- Solicitante -->
      <div class="form-group">
          <label>Solicitante:</label>
          <input type="text" value="{{ atendimento.solicitante }}" readonly>
      </div>

      <!-- Contato -->
      <div class="form-group">
          <label>Contato:</label>
          <input type="text" value="{{ atendimento.telefone }}" readonly>
      </div>

      <!-- Abrigo -->
      <div class="form-group">
          <label>Abrigo:</label>
          <input type="text" value="{{ atendimento.abrigo.nome }}" readonly>
      </div>

      <!-- Logradouro -->
      <div class="form-group">
          <label>Logradouro:</label>
          <input type="text" value="{{ atendimento.abrigo.logradouro }}" readonly>
      </div>

      <!-- Bairro -->
      <div class="form-group">
          <label>Bairro:</label>
          <input type="text" value="{{ atendimento.abrigo.bairro }}" readonly>
      </div>

      <!-- CEP -->
      <div class="form-group">
          <label>CEP:</label>
          <input type="text" value="{{ atendimento.abrigo.cep }}" readonly>
      </div>

      <!-- Latitude -->
      <div class="form-group">
          <label>Latitude:</label>
          <input type="text" value="{{ atendimento.abrigo.latitude }}" readonly>
      </div>

      <!-- Longitude -->
      <div class="form-group">
          <label>Longitude:</label>
          <input type="text" value="{{ atendimento.abrigo.longitude }}" readonly>
      </div>

      <!-- Descrição -->
      <div class="form-item full-width">
          <label>Descrição da Ocorrência:</label>
          <textarea readonly>{{ atendimento.descricao }}</textarea>
      </div>

      <div class="form-group">
            <label>Status:</label>
                <input type="text" value="{{ atendimento.status }}" readonly>
      </div>

      {% if atendimento.status == "Cancelado" %}
<div class="form-item full-width">
    <label>Justificativa do Cancelamento:</label>
    <textarea readonly>{{ atendimento.justificativa_cancelamento }}</textarea>
</div>
{% endif %}

{% if atendimento.status in ["Atendido", "Finalizado"] %}
<div class="form-item full-width">
    <label>Conclusão do Atendimento:</label>
    <textarea readonly>{{ atendimento.conclusao }}</textarea>
</div>
{% endif %}


 </div>
 
      <!-- Mapa -->
      <div class="form-item full-width">
          <label>Localização:</label>
          <div id="map" style="height: 300px; border-radius: 6px;"></div>
      </div>

   <div class="buttons">
    <!-- Sempre exibe Voltar -->
    <a href="{{ url_for('atendimentos') }}" class="btn-cancel">Voltar</a>
        <button type="button" class="btn-pdf" onclick="exportPDF()">Exportar para PDF</button>
    <!-- Exibe outros botões somente se status for Aberto ou Em Atendimento -->
    {% if atendimento.status not in ["Cancelado", "Atendido", "Finalizado"] and modo_inicio and current_user.perfil in ['Admin', 'Atendente'] %}
        <button type="button" class="btn-whatsapp" onclick="abrirModalWhatsapp()">Exportar para Whatsapp</button>
        <button type="button" class="btn-cancelar" data-bs-toggle="modal" data-bs-target="#cancelModal">Cancelar Atendimento</button>
        <button type="button" class="btn-finalizar" data-bs-toggle="modal" data-bs-target="#finalizarModal">Finalizar Atendimento</button>
    {% endif %}

<!-- Modal de Confirmação Cancelamento -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="cancelForm" method="POST" action="{{ url_for('cancelar_atendimento_ajax', id=atendimento.id) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cancelModalLabel">Confirmar Cancelamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="justificativa" class="form-label">Justificativa *</label>
            <textarea name="justificativa" id="justificativa" class="form-control" required></textarea>
          </div>
          <div class="mb-3">
            <label for="senha" class="form-label">Senha *</label>
            <input type="password" name="senha" id="senha" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" onclick="confirmarCancelar()">Confirmar Cancelamento</button>
          <div id="cancelError" style="color:red; display:none; margin-top:10px;"></div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Confirmação WhatsApp -->
<div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="whatsappModalLabel">Confirmar Exportação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          Deseja realmente exportar este atendimento para WhatsApp e alterar o status para <strong>Em Atendimento</strong>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="confirmarWhatsapp()">Confirmar</button>
        </div>
      </div>
  </div>
</div>

<!-- Modal de Finalização -->
<div class="modal fade" id="finalizarModal" tabindex="-1" aria-labelledby="finalizarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="finalizarForm" method="POST" action="{{ url_for('finalizar_atendimento_ajax', id=atendimento.id) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="finalizarModalLabel">Finalizar Atendimento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="conclusao" class="form-label">Conclusão do Atendimento *</label>
            <textarea name="conclusao" id="conclusao" class="form-control" required></textarea>
          </div>

          <div class="mb-3">
            <label for="senhaFinalizar" class="form-label">Senha *</label>
            <input type="password" name="senhaFinalizar" id="senhaFinalizar" class="form-control" required>
          </div>

          <div id="finalizarError" style="color:red; display:none; margin-top:10px;"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="confirmarFinalizar()">Confirmar Finalização</button>
        </div>
      </div>
    </form>
  </div>
</div>

</form>

<style>
.atendimento-form {
    max-width: 1500px;
    margin: 0 auto;
    padding: 30px;
    background-color: #f8f8f8;
    border-radius: 8px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px 40px;
    align-items: flex-start;
}

.form-group, .form-item {
    display: flex;
    flex-direction: column;
}

label {
    font-weight: 600;
    color: #004080;
    margin-bottom: 6px;
    font-size: 14px;
}

input, textarea {
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #aaa;
    font-size: 14px;
    height: 40px;
    background-color: #e9e9e9;
}

textarea {
    min-height: 120px;
    resize: none;
}

.form-item.full-width { flex-basis: 100%; }

.buttons {
    margin-top: 30px;
    text-align: center;
}

.btn-cancel {
    background-color: #ccc;
    color: #333;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 16px;
}

.btn-cancel:hover {
    background-color: #999;
}

@media (max-width: 768px) {
    .form-grid { grid-template-columns: 1fr; }
}

.btn-whatsapp {
    background-color: #25D366;
    color: #fff;
    padding: 10px 20px;
    border-radius: 6px;
    margin-left: 10px;
    cursor: pointer;
}

.btn-whatsapp:hover { background-color: #1ebe5d; }

.btn-pdf {
    background-color: #dc3545;
    color: #fff;
    padding: 10px 20px;
    border-radius: 6px;
    margin-left: 10px;
    cursor: pointer;
}

.btn-pdf:hover { background-color: #c82333; }

.btn-cancelar {
    background-color: #ffc107;
    color: #000;
    padding: 10px 20px;
    border-radius: 6px;
    margin-left: 10px;
    text-decoration: none;
}

.btn-cancelar:hover { background-color: #e0a800; }

.btn-finalizar {
    background-color: #007BFF;
    color: #fff;
    padding: 10px 20px;
    border-radius: 6px;
    margin-left: 10px;
    cursor: pointer;
}

.btn-finalizar:hover {
    background-color: #0069d9;
}

</style>

<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
var lat = parseFloat("{{ atendimento.abrigo.latitude or -15.7801 }}");
var lng = parseFloat("{{ atendimento.abrigo.longitude or -47.9292 }}");

var map = L.map('map').setView([lat, lng], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

L.marker([lat, lng])
    .addTo(map)
    .bindPopup("{{ atendimento.abrigo.nome }}")
    .openPopup();
</script>

<script>
function exportWhatsapp() {
    const texto = `Atendimento ID: {{ atendimento.id }}\nSolicitante: {{ atendimento.solicitante }}\nDescrição: {{ atendimento.descricao }}`;
    const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
    window.open(url, '_blank');
}

function exportPDF() {
    alert("Função de exportar PDF ainda precisa ser implementada.");
    // Aqui você pode usar jsPDF ou gerar via backend
}
</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function abrirModalWhatsapp() {
    var modal = new bootstrap.Modal(document.getElementById('whatsappModal'));
    modal.show();
}

function confirmarWhatsapp() {
    const atendimentoId = "{{ atendimento.id }}";

    
    // Abre a rota Flask que altera status e redireciona para WhatsApp
    const url = "{{ url_for('iniciar_atendimento_whatsapp', id=0) }}".replace("/0", "/" + atendimentoId);

    // Abre em nova aba
    window.open(url, '_blank');

    // Fecha modal
    var modalEl = document.getElementById('whatsappModal');
    var modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
}
</script>

<script>
function abrirModalCancelar() {
    var modal = new bootstrap.Modal(document.getElementById('cancelModal'));
    modal.show();
}

function confirmarCancelar() {
    const justificativa = document.getElementById('justificativa').value.trim();
    const senha = document.getElementById('senha').value.trim();

    if (!justificativa || !senha) {
        document.getElementById('cancelError').innerText = "Preencha justificativa e senha.";
        document.getElementById('cancelError').style.display = "block";
        return;
    }

    const atendimentoId = "{{ atendimento.id }}";
    const data = { justificativa, senha };

    fetch(`{{ url_for('cancelar_atendimento_ajax', id=atendimento.id) }}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
           
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.location.reload();  // Atualiza a página com status alterado
        } else {
            document.getElementById('cancelError').innerText = result.error;
            document.getElementById('cancelError').style.display = "block";
        }
    })
    .catch(err => {
        document.getElementById('cancelError').innerText = "Erro ao cancelar atendimento.";
        document.getElementById('cancelError').style.display = "block";
    });
}
</script>

<script>
// Seleciona a modal
var cancelModalEl = document.getElementById('cancelModal');

// Evento disparado quando a modal é fechada
cancelModalEl.addEventListener('hidden.bs.modal', function () {
    // Limpa campos
    document.getElementById('justificativa').value = '';
    document.getElementById('senha').value = '';

    // Limpa mensagem de erro
    var errorEl = document.getElementById('cancelError');
    errorEl.innerText = '';
    errorEl.style.display = 'none';
});
</script>

<script>
function confirmarFinalizar() {
    const conclusao = document.getElementById('conclusao').value.trim();
    const senha = document.getElementById('senhaFinalizar').value.trim();

    if (!conclusao || !senha) {
        document.getElementById('finalizarError').innerText = "Preencha a conclusão e a senha.";
        document.getElementById('finalizarError').style.display = "block";
        return;
    }

    const data = { conclusao, senha };

    fetch(`{{ url_for('finalizar_atendimento_ajax', id=atendimento.id) }}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.location.reload();
        } else {
            document.getElementById('finalizarError').innerText = result.error;
            document.getElementById('finalizarError').style.display = "block";
        }
    })
    .catch(err => {
        document.getElementById('finalizarError').innerText = "Erro ao finalizar atendimento.";
        document.getElementById('finalizarError').style.display = "block";
    });
}
</script>

<script>
var finalizarModalEl = document.getElementById('finalizarModal');

finalizarModalEl.addEventListener('hidden.bs.modal', function () {
    document.getElementById('conclusao').value = '';
    document.getElementById('senhaFinalizar').value = '';
    var errorEl = document.getElementById('finalizarError');
    errorEl.innerText = '';
    errorEl.style.display = 'none';
});
</script>

<script>
function exportPDF() {
    const atendimentoId = "{{ atendimento.id }}";
    const url = `/atendimento/${atendimentoId}/pdf`;
    window.open(url, '_blank');
}
</script>


{% endblock %}