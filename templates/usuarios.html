{% extends "principal.html" %}

{% block title %}Usu√°rios{% endblock %}

{% block content %}

<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
    <h2></h2>
    <a href="/config/usuarios/add">
        <button class="btn-primary-action">
            <i class="fas fa-user-plus"></i> Cadastrar Usu√°rio
        </button>
    </a>
</div>

<!-- FILTROS PERSONALIZADOS -->
<div class="filtros-container">
    <div class="filtro-item">
        <label>Nome</label>
        <div class="search-container" data-column="nome">
    <input type="text" placeholder="Clique para selecionar..." class="filter-search">
    <span class="arrow">‚ñº</span>
    <div class="options"></div>
</div>
    </div>

    <div class="filtro-item">
        <label>Login</label>
        <div class="search-container" data-column="login">
    <input type="text" placeholder="Clique para selecionar..." class="filter-search">
    <span class="arrow">‚ñº</span>
    <div class="options"></div>
</div>
    </div>

    <div class="filtro-item">
        <label>Perfil</label>
        <div class="search-container" data-column="perfil">
    <input type="text" placeholder="Clique para selecionar..." class="filter-search">
    <span class="arrow">‚ñº</span>
    <div class="options"></div>
</div>
    </div>

    <div style="display:flex; align-items:center; margin-top:18px;">
        <button id="clear-filters" class="clear-btn">üßπ Limpar Filtros</button>
    </div>
</div>

<!-- BLOCO TABELA -->
<div class="table-section">
    <h4>Lista de Usu√°rios</h4>
    <table id="tableUsuarios">
        <thead>
            <tr>
                <th style="width:30px;"><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                <th style="display:none;">ID</th>
                <th>Nome</th>
                <th>Login</th>
                <th>Perfil</th>
                <th style="width:80px; min-width:80px; text-align:center;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr>
                <td><input type="checkbox" class="select-item"></td>
                <td style="display:none;">{{ usuario.id }}</td>
                <td>{{ usuario.nome }}</td>
                <td>{{ usuario.login }}</td>
                <td>{{ usuario.perfil }}</td>
                <td class="acoes-cell">
                    <a href="/config/usuarios/edit/{{ usuario.id }}" title="Editar">
                        <i class="fas fa-pen" style="color:#ffaa00;"></i>
                    </a>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#modalExcluir{{ usuario.id }}" title="Excluir">
                        <i class="fas fa-trash-alt" style="color:#dc3545;"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de Confirma√ß√£o -->
{% for usuario in usuarios %}
<div class="modal fade" id="modalExcluir{{ usuario.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir o usu√°rio <strong>{{ usuario.nome }}</strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="/usuarios/delete/{{ usuario.id }}" method="POST">
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- LIBS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
/* FILTROS */
.filtros-container { display:flex; flex-wrap:wrap; justify-content:space-between; gap:25px; margin-bottom:15px; padding:15px 20px; border-radius:8px; background:#f8f9fa; }
.filtro-item { display:flex; flex-direction: column; min-width:180px; flex:1; }
.filtro-item label { font-size:13px; font-weight:600; color:#004080; margin-bottom:5px; }
.search-container { position:relative; width:100%; }
.filter-search { width:100%; padding:8px 28px 8px 8px; border:1px solid #aaa; border-radius:6px; font-size:13px; }
.arrow { position:absolute; right:8px; top:50%; transform:translateY(-50%); }
.options { position:absolute; top:36px; left:0; right:0; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:10; border-radius:6px; display:none; }
.option { padding:6px 10px; font-size:13px; cursor:pointer; }
.option:hover { background:#f0f0f0; }
.clear-btn { background-color:#cc0000; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; font-weight:bold; }
.clear-btn:hover { background-color:#a00000; }

/* BLOCO DA TABELA */
.table-section { background-color: #f8f9fa; padding:20px 25px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
.table-section h4 { margin-bottom:15px; font-weight:700; color:#0d6efd; }

/* TABELA */
#tableUsuarios { width:100%; border-collapse:collapse; text-align:left; font-size:14px; }
#tableUsuarios th, #tableUsuarios td { border:1px solid #dee2e6; padding:8px 12px; }
#tableUsuarios thead tr { background-color:#0d6efd; color:white; }
#tableUsuarios tbody tr:nth-child(odd) { background-color:#f8f9fa; }
#tableUsuarios tbody tr:nth-child(even) { background-color:#e9ecef; }
#tableUsuarios tbody tr:hover { background-color:#d0ebff; }
#tableUsuarios th { font-weight:bold; text-align:center; }
.acoes-cell { display:flex; justify-content:right; gap:10px; white-space:nowrap; }
.acoes-cell i, .acoes-cell .icone-placeholder { font-size:18px; width:18px; display:inline-block; text-align:center; }

/* DATATABLES FOOTER */
.dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate { color:#212529; font-weight:500; }
.dataTables_wrapper .dataTables_paginate .paginate_button { background-color:#0d6efd; color:#fff !important; border-radius:6px; padding:3px 8px; margin:0 2px; }
.dataTables_wrapper .dataTables_paginate .paginate_button:hover { background-color:#0056b3; color:#fff !important; }
.dataTables_wrapper .dataTables_paginate .paginate_button.current { background-color:#0056b3 !important; color:#fff !important; }

/* DATATABLES LENGTH */
.dataTables_length { color:#0d6efd; font-weight:600; font-size:0.95rem; margin-bottom:10px; }
.dataTables_length label { color:#212529; font-weight:600; display:flex; align-items:center; gap:6px; }
.dataTables_length select { background-color:#fff; color:#0d6efd; border:1px solid #0d6efd; border-radius:6px; padding:4px 8px; font-weight:500; cursor:pointer; }
.dataTables_length select:hover { border-color:#0056b3; }

.btn-primary-action {
    background: linear-gradient(135deg, #0d6efd, #004080);
    color: #fff;
    border: none;
    padding: 10px 24px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 6px 18px rgba(13, 110, 253, 0.35);
    transition: all 0.25s ease;
}

.btn-primary-action i {
    font-size: 14px;
}

.btn-primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(13, 110, 253, 0.45);
    background: linear-gradient(135deg, #0056b3, #002f5f);
}

.btn-primary-action:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}
</style>

<script>
function toggleAll(source) {
    document.querySelectorAll('.select-item').forEach(c => c.checked = source.checked);
}

$(document).ready(function () {
    var table = $('#tableUsuarios').DataTable({
        order: [[2, "asc"]], // Nome
        columnDefs: [
            { orderable:false, targets:[0,5] }, // checkbox e a√ß√µes
            { visible:false, targets:[1] }      // ID escondido
        ],
        language: {
            emptyTable:"Nenhum usu√°rio encontrado",
            info:"Mostrando _START_ a _END_ de _TOTAL_",
            lengthMenu:"Mostrar _MENU_",
            paginate:{ next:"Pr√≥ximo", previous:"Anterior" }
        },
        pageLength: 10,
        dom:'rt<"bottom"l<"info-wrapper"ip>><"clear">'
    });

    // Mapeamento fixo das colunas
    const colMap = { nome: 2, login: 3, perfil: 4 };

    // FILTROS
    $('.search-container').each(function() {
        const container = $(this);
        const input = container.find('.filter-search');
        const optionsDiv = container.find('.options');
        const columnName = container.data('column');
        const colIndex = colMap[columnName];
        const column = table.column(colIndex);
        let selecionados = [];

        // Pega valores √∫nicos da coluna no tbody
        const valores = column.nodes().to$().map(function(){ 
            return $(this).text().trim(); 
        }).get().filter((v,i,a) => a.indexOf(v)===i)
          .sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));

        function renderOptions(lista) {
            optionsDiv.empty();
            lista.forEach(v => {
                const checked = selecionados.includes(v) ? 'checked' : '';
                optionsDiv.append(`<div class="option"><input type="checkbox" value="${v}" ${checked}> ${v}</div>`);
            });
            optionsDiv.show();
        }

        // Abrir filtro e fechar os outros
        input.on("click", function(e){
            e.stopPropagation();

            // Fecha todos os outros filtros
            $('.search-container').not(container).find('.options').hide();

            // Alterna o filtro atual
            optionsDiv.is(":visible") ? optionsDiv.hide() : renderOptions(valores);
        });

        // Filtrar enquanto digita
        input.on("input", function(){
            const query = input.val().toLowerCase();
            renderOptions(valores.filter(v => v.toLowerCase().includes(query)));
        });

        // Sele√ß√£o de op√ß√µes
        optionsDiv.on("change","input[type=checkbox]", function(){ 
            const val = $(this).val(); 
            this.checked ? selecionados.push(val) : selecionados = selecionados.filter(v => v !== val); 
            input.val(selecionados.join(", ")); 
            selecionados.length 
                ? column.search(selecionados.map(v => '^'+$.fn.dataTable.util.escapeRegex(v)+'$').join('|'),true,false).draw() 
                : column.search('').draw(); 
        });

        // Clique fora fecha o filtro
        $(document).on("click", function(e){
            if(!$(e.target).closest('.search-container').length){
                $('.options').hide();
            }
        });

        // Reset do filtro
        container.data('reset', () => { 
            selecionados = []; 
            input.val(''); 
            column.search('').draw(); 
        });
    });

    // Bot√£o limpar filtros
    $("#clear-filters").on("click", function(){ 
        $('.search-container').each(function(){ 
            $(this).data('reset')(); 
        }); 
    });
});

</script>

{% endblock %}
