{% extends "principal.html" %}

{% block title %}
  {% if action == 'add' %}Cadastrar Abrigo{% else %}Editar Abrigo{% endif %}
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 20px;">
  {% if action == 'add' %}Cadastrar Abrigo{% else %}Editar Abrigo{% endif %}
</h2>

<form id="abrigoForm" method="POST"
      action="{% if action == 'add' %}/config/abrigos/add{% else %}/config/abrigos/edit/{{ abrigo.id }}{% endif %}">

    <div class="form-container">

        <!-- Nome -->
        <div class="form-item">
            <label for="nome">Nome <span style="color:red;">*</span></label>
            <input type="text" id="nome" name="nome" required
                   value="{{ abrigo.nome if abrigo else '' }}">
        </div>

        <!-- CEP -->
        <div class="form-item">
            <label for="cep">CEP <span style="color:red;">*</span></label>
            <div style="display:flex; align-items:center;">
                <input type="text" id="cep" name="cep" required
                       value="{{ abrigo.cep if abrigo else '' }}">
                <button type="button" id="buscarCep" style="margin-left:5px;">üîç</button>
            </div>
        </div>

        <!-- Logradouro -->
        <div class="form-item">
            <label for="logradouro">Logradouro</label>
            <input type="text" id="logradouro" name="logradouro" readonly
                   value="{{ abrigo.logradouro if abrigo else '' }}">
        </div>

        <!-- Bairro -->
        <div class="form-item">
            <label for="bairro">Bairro</label>
            <input type="text" id="bairro" name="bairro" readonly
                   value="{{ abrigo.bairro if abrigo else '' }}">
        </div>

        <!-- Cidade -->
        <div class="form-item">
            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" name="cidade" readonly
                   value="{{ abrigo.cidade if abrigo else '' }}">
        </div>

        <!-- Estado -->
        <div class="form-item">
            <label for="estado">Estado</label>
            <input type="text" id="estado" name="estado" readonly
                   value="{{ abrigo.estado if abrigo else '' }}">
        </div>

        <!-- Status -->
        <div class="form-item">
            <label for="status">Status</label>
            <select id="status" name="status" required>
                <option value="Ativo" {% if abrigo and abrigo.status=="Ativo" %}selected{% endif %}>Ativo</option>
                <option value="Inativo" {% if abrigo and abrigo.status=="Inativo" %}selected{% endif %}>Inativo</option>
            </select>
        </div>

        <!-- Latitude -->
        <div class="form-item">
            <label for="latitude">Latitude</label>
            <input type="text" id="latitude" name="latitude" value="{{ abrigo.latitude if abrigo else '' }}">
        </div>

        <!-- Longitude -->
        <div class="form-item">
            <label for="longitude">Longitude</label>
            <input type="text" id="longitude" name="longitude" value="{{ abrigo.longitude if abrigo else '' }}">
        </div>

        <!-- Mapa -->
        <div class="form-item full-width" style="position: relative;">
    <button type="button" id="btn-recenter" class="map-recenter-btn">
    <i class="fas fa-crosshairs"></i>
</button>
    <div id="map" style="height: 300px; border-radius: 6px;"></div>
</div>


        <!-- Bot√µes -->
        <div class="form-actions">
            <button type="submit" class="btn-submit">
                {% if action == 'add' %}Cadastrar{% else %}Salvar Altera√ß√µes{% endif %}
            </button>
            <a href="/config/abrigos"><button type="button" class="btn-cancel">Cancelar</button></a>
        </div>

    </div>
</form>

<!-- Scripts -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
/* ===============================
   MAPA + CEP (FINAL CONSOLIDADO)
================================ */

// ---------- Inputs ----------
const latInput = document.getElementById('latitude');
const lngInput = document.getElementById('longitude');
const cepInput = document.getElementById('cep');

// ---------- Verifica edi√ß√£o ----------
const hasCoords = latInput.value && lngInput.value;

// ---------- Coordenadas iniciais ----------
let lat = hasCoords ? parseFloat(latInput.value) : -15.7801;
let lng = hasCoords ? parseFloat(lngInput.value) : -47.9292;

// ---------- Inicializa mapa (j√° centralizado no marcador) ----------
const map = L.map('map').setView(
    [lat, lng],
    hasCoords ? 16 : 5
);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
}).addTo(map);

// ---------- Marcador ----------
const marker = L.marker([lat, lng], { draggable: true }).addTo(map);

// ---------- Centro baseado no CEP ----------
let cepCenter = hasCoords ? [lat, lng] : null;
const cepZoom = 16;

// ---------- Mapa de estados ----------
const estadosUF = {
    "Acre": "AC", "Alagoas": "AL", "Amap√°": "AP", "Amazonas": "AM",
    "Bahia": "BA", "Cear√°": "CE", "Distrito Federal": "DF",
    "Esp√≠rito Santo": "ES", "Goi√°s": "GO", "Maranh√£o": "MA",
    "Mato Grosso": "MT", "Mato Grosso do Sul": "MS",
    "Minas Gerais": "MG", "Par√°": "PA", "Para√≠ba": "PB",
    "Paran√°": "PR", "Pernambuco": "PE", "Piau√≠": "PI",
    "Rio de Janeiro": "RJ", "Rio Grande do Norte": "RN",
    "Rio Grande do Sul": "RS", "Rond√¥nia": "RO", "Roraima": "RR",
    "Santa Catarina": "SC", "S√£o Paulo": "SP", "Sergipe": "SE",
    "Tocantins": "TO"
};

// ---------- Reverse Geocoding ----------
function atualizarEnderecoPorMapa(lat, lng) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(res => res.json())
        .then(data => {
            if (!data.address) return;

            const a = data.address;

            $('#cep').val(a.postcode || '');
            $('#logradouro').val(a.road || '');
            $('#bairro').val(a.suburb || a.neighbourhood || '');
            $('#cidade').val(a.city || a.town || a.village || '');

            // Estado (UF)
            let uf = '';
            if (a.state_code) {
                uf = a.state_code.toUpperCase();
            } else if (a.state && estadosUF[a.state]) {
                uf = estadosUF[a.state];
            }
            $('#estado').val(uf);

            // Atualiza centro do CEP
            cepCenter = [lat, lng];
        });
}

// ---------- Arrastar marcador ----------
marker.on('dragend', () => {
    const pos = marker.getLatLng();

    latInput.value = pos.lat.toFixed(6);
    lngInput.value = pos.lng.toFixed(6);

    atualizarEnderecoPorMapa(pos.lat, pos.lng);
});

// ---------- Clique no mapa ----------
map.on('click', e => {
    const { lat, lng } = e.latlng;

    marker.setLatLng([lat, lng]);
    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);

    atualizarEnderecoPorMapa(lat, lng);
});

// ---------- Buscar CEP ----------
$('#buscarCep').on('click', () => {
    const cep = cepInput.value.replace(/\D/g, '');
    if (cep.length !== 8) {
        alert('CEP inv√°lido');
        return;
    }

    $.getJSON(`https://viacep.com.br/ws/${cep}/json/`, data => {
        if (data.erro) {
            alert('CEP n√£o encontrado');
            return;
        }

        $('#logradouro').val(data.logradouro);
        $('#bairro').val(data.bairro);
        $('#cidade').val(data.localidade);
        $('#estado').val(data.uf);

        const endereco = `${data.logradouro}, ${data.bairro}, ${data.localidade}, ${data.uf}, Brasil`;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`)
            .then(r => r.json())
            .then(result => {
                if (!result.length) return;

                const lat = parseFloat(result[0].lat);
                const lon = parseFloat(result[0].lon);

                latInput.value = lat.toFixed(6);
                lngInput.value = lon.toFixed(6);

                marker.setLatLng([lat, lon]);
                cepCenter = [lat, lon];
                map.setView(cepCenter, cepZoom);
            });
    });
});

// ---------- Bot√£o recentralizar ----------
document.getElementById('btn-recenter').addEventListener('click', () => {
    if (cepCenter) {
        map.setView(cepCenter, cepZoom, { animate: true });
    }
});

// ---------- For√ßa render correto do mapa ----------
setTimeout(() => {
    map.invalidateSize();
    map.setView([lat, lng], hasCoords ? 16 : 5);
}, 200);
</script>

<style>
.form-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    background-color: #f8f8f8;
    padding: 25px 30px;
    border-radius: 8px;
    max-width: 900px;
}
.form-item { display:flex; flex-direction:column; flex:1 1 300px; }
.form-item.full-width { flex-basis:100%; }
label { font-weight:600; color:#004080; margin-bottom:6px; font-size:14px; }
input, select { padding:8px 10px; border-radius:6px; border:1px solid #aaa; font-size:14px; width:100%; }
input[readonly] { background-color:#e9e9e9; }
.form-actions { display:flex; gap:15px; margin-top:20px; }
.btn-submit { background-color:#004080; color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer; }
.btn-submit:hover { background-color:#003060; }
.btn-cancel { background-color:#ccc; color:#333; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; }
.btn-cancel:hover { background-color:#aaa; }

.map-recenter-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;

    background: rgba(13, 110, 253, 0.9);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 38px;
    height: 38px;

    display: flex;
    align-items: center;
    justify-content: center;

    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.map-recenter-btn:hover {
    background: #084298;
}

</style>
{% endblock %}
