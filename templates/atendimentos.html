{% extends "principal.html" %}

{% block title %}Atendimentos{% endblock %}

{% block content %}

<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
    <h2>Atendimentos</h2>
    
    {% if current_user.perfil != "Atendente" %}
        <a href="/operador/novo-chamado">
            <button class="animated-btn">Novo Atendimento</button>
        </a>
    {% endif %}
</div>


<!-- FILTROS PERSONALIZADOS -->
<div class="filtros-container">
    <div class="filtro-item">
        <label>Solicitante</label>
        <div class="search-container" data-col="1">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options"></div>
        </div>
    </div>

    <div class="filtro-item">
        <label>Telefone</label>
        <div class="search-container" data-col="2">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options"></div>
        </div>
    </div>

    <div class="filtro-item">
        <label>Abrigo</label>
        <div class="search-container" data-col="3">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options"></div>
        </div>
    </div>

    <div class="filtro-item">
        <label>Operador</label>
        <div class="search-container" data-col="4">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options"></div>
        </div>
    </div>

    <div style="display:flex; align-items:center;">
        <button id="clear-filters" class="clear-btn">üßπ Limpar Filtros</button>
    </div>
</div>

<!-- TABELA DE ATENDIMENTOS -->
<table id="tableAtendimentos">
    <thead>
        <tr>
            <th style="width:30px;"><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
            <th>Solicitante</th>
            <th>Telefone</th>
            <th>Abrigo</th>
            <th>Operador</th>
            <th>Status</th>
            <th>Data de Cria√ß√£o</th> <!-- Nova coluna -->
            <th>Data de Finaliza√ß√£o</th> <!-- Nova coluna -->
            <th style="width:80px; min-width:80px; text-align:center;">A√ß√µes</th>
        </tr>
    </thead>

    <tbody>
        {% for c in chamados %}
        <tr>
            <td><input type="checkbox" class="select-item"></td>
            <td>{{ c.solicitante }}</td>
            <td>{{ c.telefone }}</td>
            <td>{{ c.abrigo.nome }}</td>
            <td>{{ c.operador.login }}</td>
            <td>
                <span class="status-bubble {{ c.status | lower | replace(' ', '-') }}"></span>
                {{ c.status }}
            </td>
            <td>{{ c.criado_em.strftime('%d/%m/%Y %H:%M:%S') if c.criado_em else '' }}</td> <!-- Exibe a data de cria√ß√£o -->
            <td>{{ c.finalizado_em.strftime('%d/%m/%Y %H:%M:%S') if c.finalizado_em else '' }}</td> <!-- Exibe a data de finaliza√ß√£o, caso tenha -->

            <td class="acoes-cell">


    {% if c.status == "Aberto" %}
        {% if current_user.perfil in ["Admin", "Operador"] %}
            <a href="{{ url_for('editar_atendimento', id=c.id) }}" title="Editar">
                <i class="fas fa-pen" style="color:#ffaa00; font-size:18px;"></i>
            </a>
            {% else %}
            <span class="icone-placeholder"></span>
        {% endif %}

        {% if current_user.perfil in ["Admin", "Atendente"] %}
            <a href="{{ url_for('iniciar_atendimento', id=c.id) }}" title="Iniciar Atendimento">
                <i class="fas fa-play" style="color:#00aa00; font-size:18px;"></i>
            </a>
            {% else %}
            <span class="icone-placeholder"></span>
        {% endif %}
            {% elif c.status == "Em Atendimento" %}
              {% if current_user.perfil in ["Admin", "Atendente"] %}
        <!-- √çcone para abrir detalhes -->
        <a href="{{ url_for('iniciar_atendimento', id=c.id) }}" title="Abrir Atendimento">
            <i class="fas fa-folder-open" style="color:#ffaa00; font-size:18px;"></i>
        </a>
        {% else %}
            <span class="icone-placeholder"></span>
            {% endif %}
    {% else %}
        <span class="icone-placeholder"></span>
        <span class="icone-placeholder"></span>
    {% endif %}

    <!-- Sempre dispon√≠vel -->
    <a href="{{ url_for('view_atendimento', id=c.id) }}" title="Visualizar">
        <i class="fas fa-eye" style="color:#004080; font-size:18px;"></i>
    </a>
</td>


        </tr>
        {% endfor %}
    </tbody>
</table>


<!-- LIBS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
/* FILTROS */
.filtros-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 25px;
    margin-bottom: 15px;
    padding: 15px 20px;
    border-radius: 8px;
}
.filtro-item { display:flex; flex-direction: column; min-width:180px; flex:1; }
.filtro-item label { font-size:13px; font-weight:600; color:#004080; margin-bottom:5px; }
.search-container { position:relative; width:100%; }
.filter-search { width:100%; padding:8px 28px 8px 8px; border:1px solid #aaa; border-radius:6px; font-size:13px; }
.arrow { position:absolute; right:8px; top:50%; transform:translateY(-50%); }
.options { position:absolute; top:36px; left:0; right:0; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:10; border-radius:6px; display:none; }
.option { padding:6px 10px; font-size:13px; cursor:pointer; }
.option:hover { background:#f0f0f0; }
.clear-btn { background-color:#cc0000; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; font-weight:bold; }
.clear-btn:hover { background-color:#a00000; }

/* TABELA */
#tableAtendimentos { width:100%; border-collapse:collapse; text-align:left; border:1px solid #ccc; font-size:14px; }
#tableAtendimentos th, #tableAtendimentos td { border:1px solid #ccc; padding:8px 12px; }
#tableAtendimentos thead tr { background-color:#004080; color:white; }
#tableAtendimentos tbody tr:nth-child(odd) { background-color:#f0f0f0; }
#tableAtendimentos tbody tr:nth-child(even) { background-color:#e0e0e0; }
#tableAtendimentos tbody tr:hover { background-color:#d0d0d0; }
#tableAtendimentos th { font-weight:bold; text-align:left; }

/* STATUS BOLINHA */
.status-bubble {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
    animation: blink 1s infinite;
}
.status-bubble.aberto { background-color: green; }
.status-bubble.em-atendimento { background-color: yellow; }
.status-bubble.cancelado { background-color: red; }
.status-bubble.atendido { background-color: blue; }

@keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.3; }
}

.acoes-cell {
    display: flex;
    justify-content: right;
    gap: 10px;
    white-space: nowrap;
}

.acoes-cell i,
.acoes-cell .icone-placeholder {
    font-size: 18px;  /* garante tamanho uniforme */
    width: 18px;       /* largura fixa */
    display: inline-block;
    text-align: center;
}

</style>

<script>
function toggleAll(source) {
    document.querySelectorAll('.select-item').forEach(c => c.checked = source.checked);
}

$(document).ready(function () {

    var table = $('#tableAtendimentos').DataTable({
    order: [[6, "desc"]], // ordem inicial opcional
    columnDefs: [
        { orderable:false, targets:[0,8] } // checkbox e a√ß√µes
    ],
    language: {
        emptyTable:"Nenhum atendimento encontrado",
        info:"Mostrando _START_ a _END_ de _TOTAL_",
        lengthMenu:"Mostrar _MENU_",
        paginate:{ next:"Pr√≥ximo", previous:"Anterior" }
    },
    pageLength: 10,
    dom:'rt<"bottom"l<"info-wrapper"ip>><"clear">'
});


    // FILTROS
    $('.search-container').each(function() {
        const container = $(this);
        const input = container.find('.filter-search');
        const optionsDiv = container.find('.options');
        const colIndex = container.data('col');
        const column = table.column(colIndex);

        let selecionados = [];
        const valores = column.data().unique().sort().toArray();

        function renderOptions(lista) {
            optionsDiv.empty();
            lista.forEach(v => {
                const checked = selecionados.includes(v) ? 'checked' : '';
                optionsDiv.append(`<div class="option"><input type="checkbox" value="${v}" ${checked}> ${v}</div>`);
            });
            optionsDiv.show();
        }

        input.on("click", function(e){
            e.stopPropagation();
            if(optionsDiv.is(":visible")) optionsDiv.hide();
            else renderOptions(valores);
        });

        input.on("input", function(){
            const query = input.val().toLowerCase();
            const filtradas = valores.filter(v => v.toLowerCase().includes(query));
            renderOptions(filtradas);
        });

        optionsDiv.on("change","input[type=checkbox]",function(){
            const val = $(this).val();
            if(this.checked) selecionados.push(val);
            else selecionados = selecionados.filter(v => v !== val);
            input.val(selecionados.join(", "));
            if(selecionados.length) {
                const regex = selecionados.map(v => '^'+$.fn.dataTable.util.escapeRegex(v)+'$').join('|');
                column.search(regex,true,false).draw();
            } else column.search('').draw();
        });

        $(document).on("click", function(e){
            if(!$(e.target).closest(container).length) optionsDiv.hide();
        });

        container.data('reset', () => { selecionados=[]; input.val(''); column.search('').draw(); });
    });

    $("#clear-filters").on("click", function(){
        $('.search-container').each(function(){ $(this).data('reset')(); });
    });

});
</script>

{% endblock %}
